<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR.js + GitHub JSON</title>
    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.0/aframe/build/aframe-ar.js"></script>
    <script src="https://cozmo.github.io/jsQR/jsQR.js"></script>
  </head>

  <body style='margin : 0px; overflow: hidden;'>
    <a-scene embedded arjs='sourceType: webcam;'>
      <a-marker preset='custom' type='pattern' url='https://prasannaboga.github.io/demo_arjs02/images/pattern-qrcode-square.patt'>
        <a-box id="myBox" color="black" position="0 0 0" scale="1 1 1" material='opacity: 0.7;'>
          <a-animation attribute="rotation" to="360 45 90" dur="9000" repeat="indefinite" easing="linear"></a-animation>
        </a-box>
        <a-text id="myText" value="Inquadra il QR..." color="yellow" align="center" position="0 1.5 0" rotation="-90 0 0" scale="2 2 2"></a-text>
      </a-marker>
      
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const canvasElement = document.createElement("canvas");
      const canvasContext = canvasElement.getContext("2d");
      const myBox = document.querySelector("#myBox");
      const myText = document.querySelector("#myText");
      
      // Indirizzo base del tuo file JSON su GitHub
      const GITHUB_JSON_URL = "https://raw.githubusercontent.com/simonevetere/xyz/refs/heads/main/test.json";

      setInterval(function() {
        const video = document.querySelector("video");
        if (video && video.readyState === video.HAVE_ENOUGH_DATA) {
          canvasElement.height = video.videoHeight;
          canvasElement.width = video.videoWidth;
          canvasContext.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
          
          const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
          const qrCode = jsQR(imageData.data, imageData.width, imageData.height);

          // Se il QR viene letto (non importa cosa c'Ã¨ scritto dentro, noi scarichiamo il JSON)
          if (qrCode && qrCode.data !== "") {
            console.log("QR rilevato, scarico dati...");
            
            fetch(GITHUB_JSON_URL)
              .then(response => response.json())
              .then(data => {
                // Aggiorniamo il cubo e il testo con i dati del JSON
                myBox.setAttribute("color", "green"); // Diventa verde quando legge con successo
                myText.setAttribute("value", data.device_name); // Mostra "Prototipo XRI 01"
                console.log("Dati JSON:", data);
              })
              .catch(err => {
                myText.setAttribute("value", "Errore JSON");
                console.error(err);
              });
          }
        }
      }, 2000); // Controlla ogni 2 secondi
    </script>
  </body>
</html>
